# Configure the downloader script
CONFIGURE_FILE(${CMAKE_SOURCE_DIR}/tools/data/endl_downloader.py.in
  ${CMAKE_CURRENT_BINARY_DIR}/endl_downloader.py @ONLY)

MACRO(CHECK_FOR_FILES DIR DOWNLOAD_NEEDED)
  IF(NOT EXISTS ${CMAKE_CURRENT_BINARY_DIR}/${DIR}/za001000)
    SET(${DOWNLOAD_NEEDED} TRUE)
  ENDIF()

  IF(NOT EXISTS ${CMAKE_CURRENT_BINARY_DIR}/${DIR}/za006000)
    SET(${DOWNLOAD_NEEDED} TRUE)
  ENDIF()

  IF(NOT EXISTS ${CMAKE_CURRENT_BINARY_DIR}/${DIR}/za013000)
    SET(${DOWNLOAD_NEEDED} TRUE)
  ENDIF()

  IF(NOT EXISTS ${CMAKE_CURRENT_BINARY_DIR}/${DIR}/za013000)
    SET(${DOWNLOAD_NEEDED} TRUE)
  ENDIF()

  IF(NOT EXISTS ${CMAKE_CURRENT_BINARY_DIR}/${DIR}/za014000)
    SET(${DOWNLOAD_NEEDED} TRUE)
  ENDIF()

  IF(NOT EXISTS ${CMAKE_CURRENT_BINARY_DIR}/${DIR}/za082000)
    SET(${DOWNLOAD_NEEDED} TRUE)
  ENDIF()
ENDMACRO()

MACRO(FIND_ENDL_FILES DIR)
  FIND_FILE(${DIR}1  za001000 ${CMAKE_CURRENT_BINARY_DIR}/${DIR})
  FIND_FILE(${DIR}6  za006000 ${CMAKE_CURRENT_BINARY_DIR}/${DIR})
  FIND_FILE(${DIR}13 za013000 ${CMAKE_CURRENT_BINARY_DIR}/${DIR})
  FIND_FILE(${DIR}14 za014000 ${CMAKE_CURRENT_BINARY_DIR}/${DIR})
  FIND_FILE(${DIR}82 za082000 ${CMAKE_CURRENT_BINARY_DIR}/${DIR})
ENDMACRO()

SET(DOWNLOAD_NEEDED FALSE)

CHECK_FOR_FILES(eadl DOWNLOAD_NEEDED)
CHECK_FOR_FILES(epdl DOWNLOAD_NEEDED)
CHECK_FOR_FILES(eedl DOWNLOAD_NEEDED)

IF(DOWNLOAD_NEEDED)
  SET(ENDL_DOWNLOADER endl_downloader.sh)
 
  EXECUTE_PROCESS(COMMAND ${PYTHON_EXECUTABLE} ${CMAKE_CURRENT_BINARY_DIR}/endl_downloader.py -l "H,C,Al,Si,Pb"
    WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
    OUTPUT_FILE ${ENDL_DOWNLOADER}
    RESULT_VARIABLE RETURN_CODE)

  IF(NOT "${RETURN_CODE}" STREQUAL "0")
    MESSAGE(FATAL_ERROR "Could not generate the ${ENDL_DOWNLOADER} script!" )
  ENDIF()

  MESSAGE("-- Downloading ENDL data used for testing")
  
  EXECUTE_PROCESS(COMMAND bash ${ENDL_DOWNLOADER} -d ./ -l
    WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
    ERROR_FILE endl_download_log.txt
    RESULT_VARIABLE RETURN_CODE)
  
  IF(NOT "${RETURN_CODE}" STREQUAL "0")
    MESSAGE(FATAL_ERROR "Could not download the ENDL data!")
  ENDIF()
ENDIF()

# Always call the find macros - if the cache is deleted these files will need
# to be found again even though DOWNLOAD_NEEDED will be false
FIND_ENDL_FILES(eadl)
FIND_ENDL_FILES(epdl)
FIND_ENDL_FILES(eedl)

