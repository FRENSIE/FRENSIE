#! /usr/bin/python2.7
#-----------------------------------------------------------------------------#
## MonteCarlo.Manager electroatomic reaction unit tests
#  \file   tstMonteCarlo.Manager.ParticleSimulationManager.py
#  \author Luke Kersting
#  \brief  Unit tests for the MonteCarlo.Manager.ParticleSimulationManager helpers
#-----------------------------------------------------------------------------#

# System imports
import sys
import signal
import unittest
from optparse import *
import numpy
import os.path
from os import path

# Parse the command-line arguments
parser = OptionParser()
parser.add_option("-v", "--verbosity", type="int", dest="verbosity", default=2,
                  help="Set the verbosity level [default 2]")
parser.add_option("-d", "--database_path", type="string", dest="database_path", default="",
                  help="Set the path to the scattering center database that will be used to create the model")
parser.add_option("-t", "--threads", type="int", dest="threads",
                  help="Set the number of threads.")
parser.add_option("-f", "--have_hdf5",
                  action="store_true", dest="have_hdf5", default=False,
                  help="Set the HAVE_FRENSIE_HDF5 to true.")

options,args = parser.parse_args()

from testingHelpers import importPyFrensieModuleFromBuildDir
Geometry = importPyFrensieModuleFromBuildDir('Geometry')
Utility = importPyFrensieModuleFromBuildDir('Utility')
MPI = importPyFrensieModuleFromBuildDir('Utility.MPI')
MonteCarlo = importPyFrensieModuleFromBuildDir('MonteCarlo')
Collision = importPyFrensieModuleFromBuildDir('MonteCarlo.Collision')
ActiveRegion = importPyFrensieModuleFromBuildDir('MonteCarlo.ActiveRegion')
Event = importPyFrensieModuleFromBuildDir('MonteCarlo.Event')
Manager = importPyFrensieModuleFromBuildDir('MonteCarlo.Manager')
Data = importPyFrensieModuleFromBuildDir('Data')

#-----------------------------------------------------------------------------#
# Tests.
#-----------------------------------------------------------------------------#
# Test the coupled electroatomic reaction
class ParticleSimulationManagerTestCase(unittest.TestCase):
    "TestCase class for MonteCarlo.Manager ParticleSimulationManager"

    @classmethod
    def setUpClass(cls):

        # Set the number of requested threads
        cls.threads = options.threads

        cls.database_path = options.database_path
        database = Data.ScatteringCenterPropertiesDatabase(cls.database_path)
        h_properties = database.getAtomProperties( Data.ZAID(1001) )
        h1_properties = database.getNuclideProperties( Data.ZAID(1001) )
        cls.scattering_center_definition_database = Collision.ScatteringCenterDefinitionDatabase()
        h_definition = cls.scattering_center_definition_database.createDefinition( "H1 @ 293.6K", Data.ZAID(1001) )

        h_definition.setPhotoatomicDataProperties(
          h_properties.getSharedPhotoatomicDataProperties(
                       Data.PhotoatomicDataProperties.Native_EPR_FILE, 0 ) )

        h_definition.setAdjointPhotoatomicDataProperties(
          h_properties.getSharedAdjointPhotoatomicDataProperties(
                Data.AdjointPhotoatomicDataProperties.Native_EPR_FILE, 0 ) )

        h_definition.setElectroatomicDataProperties(
          h_properties.getSharedElectroatomicDataProperties(
                     Data.ElectroatomicDataProperties.Native_EPR_FILE, 0 ) )

        h_definition.setAdjointElectroatomicDataProperties(
          h_properties.getSharedAdjointElectroatomicDataProperties(
              Data.AdjointElectroatomicDataProperties.Native_EPR_FILE, 0 ) )

        h_definition.setNuclearDataProperties(
          h1_properties.getSharedNuclearDataPropertiesAtMeV(
                                         Data.NuclearDataProperties.ACE_FILE,
                                         7,
                                         2.53010E-08,
                                         True ) )

        cls.material_definition_database = Collision.MaterialDefinitionDatabase()

        cls.material_definition_database.addDefinition( "H1 @ 293.6K", 1,
                                                      ("H1 @ 293.6K",), (1.0,) )

        cls.unfilled_model = Geometry.InfiniteMediumModel( 1, 1, -1.0 )

        tmp_particle_distribution = ActiveRegion.StandardParticleDistribution( "test dist" )

        cls.particle_distribution = tmp_particle_distribution

    def setUp(self):
        # Initialize the FRENSIE global MPI Session
        self.session = MPI.GlobalMPISession( len(sys.argv), sys.argv )

#-----------------------------------------------------------------------------#
    # Check that history details can be returned
    def testGet_history_details(self):
        "*Test MonteCarlo.Manager.ParticleSimulationManager get_history_details"
        properties = MonteCarlo.SimulationProperties()
        properties.setParticleMode( MonteCarlo.NEUTRON_PHOTON_MODE )
        properties.setNumberOfHistories( 5 )

        model = Collision.FilledGeometryModel(
                                self.database_path,
                                self.scattering_center_definition_database,
                                self.material_definition_database,
                                properties,
                                self.unfilled_model,
                                False )


        source_component = [ActiveRegion.StandardNeutronSourceComponent( 0, 1.0, self.unfilled_model, self.particle_distribution )]

        source = ActiveRegion.StandardParticleSource( source_component )
        event_handler = Event.EventHandler( properties )

        factory = Manager.ParticleSimulationManagerFactory( model,
                                                            source,
                                                            event_handler,
                                                            properties,
                                                            "test_sim",
                                                            "xml",
                                                            self.threads )

        manager = factory.getManager()

        self.assertEqual( manager.getNextHistory(), 0 )
        self.assertEqual( manager.getNumberOfRendezvous(), 0 )
        self.assertEqual( manager.getRendezvousBatchSize(), 5 )
        self.assertEqual( manager.getBatchSize(), 5 )

        # Reset variables
        source_component = None
        source = None
        factory = None
        manager = None

        properties = MonteCarlo.SimulationProperties()
        properties.setParticleMode( MonteCarlo.NEUTRON_PHOTON_MODE )
        properties.setNumberOfHistories( 1005 )
        properties.setMinNumberOfRendezvous( 10 )

        model = Collision.FilledGeometryModel(
                                self.database_path,
                                self.scattering_center_definition_database,
                                self.material_definition_database,
                                properties,
                                self.unfilled_model,
                                False )


        source_component = [ActiveRegion.StandardNeutronSourceComponent( 0, 1.0, self.unfilled_model, self.particle_distribution )]

        source = ActiveRegion.StandardParticleSource( source_component )
        event_handler = Event.EventHandler( properties )

        factory = Manager.ParticleSimulationManagerFactory( model,
                                                            source,
                                                            event_handler,
                                                            properties,
                                                            "test_sim",
                                                            "xml",
                                                            self.threads )

        manager = factory.getManager()

        self.assertEqual( manager.getNextHistory(), 0 )
        self.assertEqual( manager.getNumberOfRendezvous(), 0 )
        self.assertEqual( manager.getRendezvousBatchSize(), 100 )
        self.assertEqual( manager.getBatchSize(), 100 )

        # Reset variables
        source_component = None
        source = None
        factory = None
        manager = None

        properties = MonteCarlo.SimulationProperties()
        properties.setParticleMode( MonteCarlo.NEUTRON_PHOTON_MODE )
        properties.setNumberOfHistories( 1005 )
        properties.setMinNumberOfRendezvous( 10 )
        properties.setMaxRendezvousBatchSize( 50 )

        model = Collision.FilledGeometryModel(
                                self.database_path,
                                self.scattering_center_definition_database,
                                self.material_definition_database,
                                properties,
                                self.unfilled_model,
                                False )


        source_component = [ActiveRegion.StandardNeutronSourceComponent( 0, 1.0, self.unfilled_model, self.particle_distribution )]

        source = ActiveRegion.StandardParticleSource( source_component )
        event_handler = Event.EventHandler( properties )

        factory = Manager.ParticleSimulationManagerFactory( model,
                                                            source,
                                                            event_handler,
                                                            properties,
                                                            "test_sim",
                                                            "xml",
                                                            self.threads )

        manager = factory.getManager()

        self.assertEqual( manager.getNextHistory(), 0 )
        self.assertEqual( manager.getNumberOfRendezvous(), 0 )
        self.assertEqual( manager.getRendezvousBatchSize(), 50 )
        self.assertEqual( manager.getBatchSize(), 50 )

        # Reset variables
        source_component = None
        source = None
        factory = None
        manager = None
        properties = None

        properties = MonteCarlo.SimulationProperties()
        properties.setParticleMode( MonteCarlo.NEUTRON_PHOTON_MODE )
        properties.setNumberOfHistories( 1000000 )
        properties.setMinNumberOfRendezvous( 5 )
        properties.setMaxRendezvousBatchSize( 100000 )
        properties.setMinNumberOfBatchesPerRendezvous( 10 )

        model = Collision.FilledGeometryModel(
                                self.database_path,
                                self.scattering_center_definition_database,
                                self.material_definition_database,
                                properties,
                                self.unfilled_model,
                                False )

        source_component = [ActiveRegion.StandardNeutronSourceComponent( 0, 1.0, self.unfilled_model, self.particle_distribution )]

        source = ActiveRegion.StandardParticleSource( source_component )
        event_handler = Event.EventHandler( properties )

        factory = Manager.ParticleSimulationManagerFactory( model,
                                                            source,
                                                            event_handler,
                                                            properties,
                                                            "test_sim",
                                                            "xml",
                                                            self.threads )

        manager = factory.getManager()

        self.assertEqual( manager.getNextHistory(), 0 )
        self.assertEqual( manager.getNumberOfRendezvous(), 0 )
        self.assertEqual( manager.getRendezvousBatchSize(), 100000 )
        self.assertEqual( manager.getBatchSize(), 10000 )

        # Reset variables
        source_component = None
        source = None
        factory = None
        manager = None

        properties = MonteCarlo.SimulationProperties()
        properties.setParticleMode( MonteCarlo.NEUTRON_PHOTON_MODE )
        properties.setNumberOfHistories( 1000000 )
        properties.setMinNumberOfRendezvous( 5 )
        properties.setMaxRendezvousBatchSize( 100000 )
        properties.setMinNumberOfBatchesPerRendezvous( 10 )
        properties.setMaxBatchSize( 5000 )

        model = Collision.FilledGeometryModel(
                                self.database_path,
                                self.scattering_center_definition_database,
                                self.material_definition_database,
                                properties,
                                self.unfilled_model,
                                False )


        source_component = [ActiveRegion.StandardNeutronSourceComponent( 0, 1.0, self.unfilled_model, self.particle_distribution )]

        source = ActiveRegion.StandardParticleSource( source_component )
        event_handler = Event.EventHandler( properties )

        factory = Manager.ParticleSimulationManagerFactory( model,
                                                            source,
                                                            event_handler,
                                                            properties,
                                                            "test_sim",
                                                            "xml",
                                                            self.threads )

        manager = factory.getManager()

        self.assertEqual( manager.getNextHistory(), 0 )
        self.assertEqual( manager.getNumberOfRendezvous(), 0 )
        self.assertEqual( manager.getRendezvousBatchSize(), 100000 )
        self.assertEqual( manager.getBatchSize(), 5000 )

        # Reset variables
        source_component = None
        source = None
        factory = None
        manager = None

        properties = MonteCarlo.SimulationProperties()
        properties.setParticleMode( MonteCarlo.NEUTRON_PHOTON_MODE )
        properties.setNumberOfHistories( 0 )
        properties.setMinNumberOfRendezvous( 5 )
        properties.setMaxRendezvousBatchSize( 1000000 )
        properties.setMinNumberOfBatchesPerRendezvous( 10 )
        properties.setMaxBatchSize( 50000 )

        model = Collision.FilledGeometryModel(
                                self.database_path,
                                self.scattering_center_definition_database,
                                self.material_definition_database,
                                properties,
                                self.unfilled_model,
                                False )


        source_component = [ActiveRegion.StandardNeutronSourceComponent( 0, 1.0, self.unfilled_model, self.particle_distribution )]

        source = ActiveRegion.StandardParticleSource( source_component )
        event_handler = Event.EventHandler( properties )

        factory = Manager.ParticleSimulationManagerFactory( model,
                                                            source,
                                                            event_handler,
                                                            properties,
                                                            "test_sim",
                                                            "xml",
                                                            self.threads )

        manager = factory.getManager()

        self.assertEqual( manager.getNextHistory(), 0 )
        self.assertEqual( manager.getNumberOfRendezvous(), 0 )
        self.assertEqual( manager.getRendezvousBatchSize(), 1000000 )
        self.assertEqual( manager.getBatchSize(), 50000 )

        # Reset variables
        source_component = None
        source = None
        factory = None
        manager = None

#-----------------------------------------------------------------------------#
    # Check that a particle simulation manager can rename the simulation
    def testSetSimulationName(self):
        "*Test MonteCarlo.Manager.ParticleSimulationManager setSimulationName"
        properties = MonteCarlo.SimulationProperties()
        properties.setParticleMode( MonteCarlo.NEUTRON_PHOTON_MODE )
        properties.setNumberOfHistories( 5 )

        model = Collision.FilledGeometryModel(
                                self.database_path,
                                self.scattering_center_definition_database,
                                self.material_definition_database,
                                properties,
                                self.unfilled_model,
                                False )

        source_component = [ActiveRegion.StandardNeutronSourceComponent( 0, 1.0, self.unfilled_model, self.particle_distribution )]

        source = ActiveRegion.StandardParticleSource( source_component )
        event_handler = Event.EventHandler( properties )

        factory = Manager.ParticleSimulationManagerFactory( model,
                                                            source,
                                                            event_handler,
                                                            properties,
                                                            "test_sim",
                                                            "xml",
                                                            self.threads )

        manager = factory.getManager()
        manager.useMultipleRendezvousFiles()

        self.assertEqual( manager.getSimulationName(), "test_sim" )

        manager.setSimulationName( "test_sim_2" )

        self.assertEqual( manager.getSimulationName(), "test_sim_2" )
        self.assertTrue( path.exists( "test_sim_2_rendezvous_0.xml" ) )

#-----------------------------------------------------------------------------#
    # Check that a particle simulation manager can change the archive type
    def testSetSimulationArchiveType(self):
        "*Test MonteCarlo.Manager.ParticleSimulationManager setSimulationArchiveType"
        properties = MonteCarlo.SimulationProperties()
        properties.setParticleMode( MonteCarlo.NEUTRON_PHOTON_MODE )
        properties.setNumberOfHistories( 5 )

        model = Collision.FilledGeometryModel(
                                self.database_path,
                                self.scattering_center_definition_database,
                                self.material_definition_database,
                                properties,
                                self.unfilled_model,
                                False )

        source_component = [ActiveRegion.StandardNeutronSourceComponent( 0, 1.0, self.unfilled_model, self.particle_distribution )]

        source = ActiveRegion.StandardParticleSource( source_component )
        event_handler = Event.EventHandler( properties )

        factory = Manager.ParticleSimulationManagerFactory( model,
                                                            source,
                                                            event_handler,
                                                            properties,
                                                            "test_sim",
                                                            "xml",
                                                            self.threads )

        manager = factory.getManager()
        manager.useSingleRendezvousFile()

        self.assertEqual( manager.getSimulationArchiveType(), "xml" )

        manager.setSimulationArchiveType( "txt" )

        self.assertEqual( manager.getSimulationArchiveType(), "txt" )
        self.assertTrue( path.exists( "test_sim_rendezvous.txt" ) )

#-----------------------------------------------------------------------------#
    # Check that the simulation name and archive can be changed simultaneously
    def testSetSimulationNameAndArchiveType(self):
        "*Test MonteCarlo.Manager.ParticleSimulationManager setSimulationNameAndArchiveType"
        properties = MonteCarlo.SimulationProperties()
        properties.setParticleMode( MonteCarlo.NEUTRON_PHOTON_MODE )
        properties.setNumberOfHistories( 5 )

        model = Collision.FilledGeometryModel(
                                self.database_path,
                                self.scattering_center_definition_database,
                                self.material_definition_database,
                                properties,
                                self.unfilled_model,
                                False )

        source_component = [ActiveRegion.StandardNeutronSourceComponent( 0, 1.0, self.unfilled_model, self.particle_distribution )]

        source = ActiveRegion.StandardParticleSource( source_component )
        event_handler = Event.EventHandler( properties )

        factory = Manager.ParticleSimulationManagerFactory( model,
                                                            source,
                                                            event_handler,
                                                            properties,
                                                            "test_sim",
                                                            "xml",
                                                            self.threads )

        manager = factory.getManager()
        manager.useMultipleRendezvousFiles()

        self.assertEqual( manager.getSimulationName(), "test_sim" )
        self.assertEqual( manager.getSimulationArchiveType(), "xml" )

        manager.setSimulationNameAndArchiveType( "test_sim_2", "txt" )

        self.assertEqual( manager.getSimulationName(), "test_sim_2" )
        self.assertEqual( manager.getSimulationArchiveType(), "txt" )
        self.assertTrue( path.exists( "test_sim_2_rendezvous_0.txt" ) )

#-----------------------------------------------------------------------------#
    # Check that the geometry model can be returned
    def testGetModel(self):
        "*Test MonteCarlo.Manager.ParticleSimulationManager getModel"
        properties = MonteCarlo.SimulationProperties()
        properties.setParticleMode( MonteCarlo.NEUTRON_PHOTON_MODE )
        properties.setNumberOfHistories( 5 )

        model = Collision.FilledGeometryModel(
                                self.database_path,
                                self.scattering_center_definition_database,
                                self.material_definition_database,
                                properties,
                                self.unfilled_model,
                                False )

        source_component = [ActiveRegion.StandardNeutronSourceComponent( 0, 1.0, self.unfilled_model, self.particle_distribution )]

        source = ActiveRegion.StandardParticleSource( source_component )
        event_handler = Event.EventHandler( properties )

        factory = Manager.ParticleSimulationManagerFactory( model, source, event_handler, properties, "test_sim", "xml", self.threads )

        manager = factory.getManager()

        test_model = manager.getModel()
        # self.assertTrue( manager.getModel() == model )

#-----------------------------------------------------------------------------#
    # Check that the source can be returned
    def testGetSource(self):
        "*Test MonteCarlo.Manager.ParticleSimulationManager getSource"
        properties = MonteCarlo.SimulationProperties()
        properties.setParticleMode( MonteCarlo.NEUTRON_PHOTON_MODE )
        properties.setNumberOfHistories( 5 )

        model = Collision.FilledGeometryModel(
                                self.database_path,
                                self.scattering_center_definition_database,
                                self.material_definition_database,
                                properties,
                                self.unfilled_model,
                                False )

        source_component = [ActiveRegion.StandardNeutronSourceComponent( 0, 1.0, self.unfilled_model, self.particle_distribution )]

        source = ActiveRegion.StandardParticleSource( source_component )
        event_handler = Event.EventHandler( properties )

        factory = Manager.ParticleSimulationManagerFactory( model, source, event_handler, properties, "test_sim", "xml", self.threads )

        manager = factory.getManager()

        test_source = manager.getSource()
        # self.assertTrue( manager.getSource() == source )

#-----------------------------------------------------------------------------#
    # Check that the event handler can be returned
    def testGetEventHandler(self):
        "*Test MonteCarlo.Manager.ParticleSimulationManager getEventHandler"

        properties = MonteCarlo.SimulationProperties()
        properties.setParticleMode( MonteCarlo.NEUTRON_PHOTON_MODE )
        properties.setNumberOfHistories( 5 )

        model = Collision.FilledGeometryModel(
                                self.database_path,
                                self.scattering_center_definition_database,
                                self.material_definition_database,
                                properties,
                                self.unfilled_model,
                                False )

        source_component = [ActiveRegion.StandardNeutronSourceComponent( 0, 1.0, self.unfilled_model, self.particle_distribution )]

        source = ActiveRegion.StandardParticleSource( source_component )
        event_handler = Event.EventHandler( properties )

        factory = Manager.ParticleSimulationManagerFactory( model, source, event_handler, properties, "test_sim", "xml", self.threads )

        manager = factory.getManager()

        test_event_handler = manager.getEventHandler()
        # self.assertTrue( manager.getEventHandler() == event_handler )

#-----------------------------------------------------------------------------#
    # Check that a simulation can be run
    def testRunSimulation_history_wall(self):
        "*Test MonteCarlo.Manager.ParticleSimulationManager runSimulation_history_wall"
        properties = MonteCarlo.SimulationProperties()
        properties.setParticleMode( MonteCarlo.PHOTON_MODE )
        properties.setNumberOfHistories( 5 )

        model = Collision.FilledGeometryModel(
                                self.database_path,
                                self.scattering_center_definition_database,
                                self.material_definition_database,
                                properties,
                                self.unfilled_model,
                                False )


        source_component = [ActiveRegion.StandardNeutronSourceComponent( 0, 1.0, self.unfilled_model, self.particle_distribution )]

        source = ActiveRegion.StandardParticleSource( source_component )
        event_handler = Event.EventHandler( properties )

        factory = Manager.ParticleSimulationManagerFactory( model,
                                                            source,
                                                            event_handler,
                                                            properties,
                                                            "test_sim",
                                                            "xml",
                                                            self.threads )

        manager = factory.getManager()
        manager.runSimulation()

        self.assertEqual( manager.getNextHistory(), 5 )
        self.assertEqual( manager.getNumberOfRendezvous(), 2 )

#-----------------------------------------------------------------------------#
    # Check that a simulation can be run
    def testRunSimulation_wall_time(self):
        "*Test MonteCarlo.Manager.ParticleSimulationManager runSimulation_wall_time"
        properties = MonteCarlo.SimulationProperties()
        properties.setParticleMode( MonteCarlo.PHOTON_MODE )
        properties.setSimulationWallTime( 0.5 )
        properties.setMaxRendezvousBatchSize( 10 )

        model = Collision.FilledGeometryModel(
                                self.database_path,
                                self.scattering_center_definition_database,
                                self.material_definition_database,
                                properties,
                                self.unfilled_model,
                                False )


        source_component = [ActiveRegion.StandardNeutronSourceComponent( 0, 1.0, self.unfilled_model, self.particle_distribution )]

        source = ActiveRegion.StandardParticleSource( source_component )
        event_handler = Event.EventHandler( properties )

        factory = Manager.ParticleSimulationManagerFactory( model,
                                                            source,
                                                            event_handler,
                                                            properties,
                                                            "test_sim",
                                                            "xml",
                                                            self.threads )

        manager = factory.getManager()
        manager.runSimulation()

        self.assertTrue( manager.getNextHistory() > 0 )
        self.assertTrue( manager.getNumberOfRendezvous() > 0 )

    #-----------------------------------------------------------------------------#
    # Check that a particle simulation manager can run an interruptible simulation
    def testRunInterruptibleSimulation(self):
        "*Test MonteCarlo.Manager.ParticleSimulationManager runInterruptibleSimulation"
        if Utility.OpenMPProperties.isOpenMPUsed():
            properties = MonteCarlo.SimulationProperties()
            properties.setParticleMode( MonteCarlo.PHOTON_MODE )
            properties.setMaxRendezvousBatchSize( 100 )
            properties.setMaxBatchSize( 10 )
            
            model = Collision.FilledGeometryModel(
                                self.database_path,
                                self.scattering_center_definition_database,
                                self.material_definition_database,
                                properties,
                                self.unfilled_model,
                                False )


            source_component = [ActiveRegion.StandardNeutronSourceComponent( 0, 1.0, self.unfilled_model, self.particle_distribution )]

            source = ActiveRegion.StandardParticleSource( source_component )
            
            event_handler = Event.EventHandler( properties )
            
            
            factory = Manager.ParticleSimulationManagerFactory( model,
                                                                source,
                                                                event_handler,
                                                                properties,
                                                                "test_sim",
                                                                "xml",
                                                                self.threads )

            manager = factory.getManager()

            manager.runInterruptibleSimulationForDuration( 0.2 )

            self.assertTrue( manager.getNextHistory() > 0 )
            self.assertTrue( manager.getNumberOfRendezvous() > 0 )

#-----------------------------------------------------------------------------#
    # Check that a particle simulation summary can be printed
    def testPrintSimulationSummary(self):
        "*Test MonteCarlo.Manager.ParticleSimulationManager printSimulationSummary"
        properties = MonteCarlo.SimulationProperties()
        properties.setParticleMode( MonteCarlo.PHOTON_MODE )
        properties.setNumberOfHistories( 5 )

        model = Collision.FilledGeometryModel(
                                self.database_path,
                                self.scattering_center_definition_database,
                                self.material_definition_database,
                                properties,
                                self.unfilled_model,
                                False )


        source_component = [ActiveRegion.StandardNeutronSourceComponent( 0, 1.0, self.unfilled_model, self.particle_distribution )]

        source = ActiveRegion.StandardParticleSource( source_component )
        event_handler = Event.EventHandler( properties )

        factory = Manager.ParticleSimulationManagerFactory( model,
                                                            source,
                                                            event_handler,
                                                            properties,
                                                            "test_sim",
                                                            "xml",
                                                            self.threads )

        manager = factory.getManager()
        manager.runSimulation()
        # manager.printSimulationSummary( std.cout ) )

#-----------------------------------------------------------------------------#
    # Check that a particle simulation summary can be logged
    def testLogSimulationSummary(self):
        "*Test MonteCarlo.Manager.ParticleSimulationManager logSimulationSummary"
        properties = MonteCarlo.SimulationProperties()
        properties.setParticleMode( MonteCarlo.PHOTON_MODE )
        properties.setNumberOfHistories( 5 )

        model = Collision.FilledGeometryModel(
                                self.database_path,
                                self.scattering_center_definition_database,
                                self.material_definition_database,
                                properties,
                                self.unfilled_model,
                                False )


        source_component = [ActiveRegion.StandardNeutronSourceComponent( 0, 1.0, self.unfilled_model, self.particle_distribution )]

        source = ActiveRegion.StandardParticleSource( source_component )
        event_handler = Event.EventHandler( properties )

        factory = Manager.ParticleSimulationManagerFactory( model,
                                                            source,
                                                            event_handler,
                                                            properties,
                                                            "test_sim",
                                                            "xml",
                                                            self.threads )

        manager = factory.getManager()
        manager.runSimulation()
        manager.logSimulationSummary()

class ParametrizedTestCase(unittest.TestCase):
    """ TestCase classes that want to be parametrized should
        inherit from this class.
    """
    def __init__(self, methodName='runTest', archive_type=None, source_id=None):
        super(ParametrizedTestCase, self).__init__(methodName)
        self.archive_type = archive_type
        self.source_id = source_id

    @staticmethod
    def parametrize(testcase_class, archive_type=None, source_id=None):
        """ Create a suite containing all tests taken from the given
            subclass, passing them the parameters 'archive_type' and 'source_id'.
        """
        testloader = unittest.TestLoader()
        testnames = testloader.getTestCaseNames(testcase_class)
        suite = unittest.TestSuite()
        for name in testnames:
            suite.addTest(testcase_class(name, archive_type=archive_type, source_id=source_id))
        return suite

#-----------------------------------------------------------------------------#
# Test the coupled electroatomic reaction
class ParticleSimulationManagerRestartTestCase(ParametrizedTestCase):
    "TestCase class for MonteCarlo.Manager ParticleSimulationManager restart"

    @classmethod
    def setUpClass(cls):
        # Set the number of requested threads
        cls.threads = options.threads

        cls.database_path = options.database_path
        database = Data.ScatteringCenterPropertiesDatabase(cls.database_path)
        h_properties = database.getAtomProperties( Data.ZAID(1001) )
        h1_properties = database.getNuclideProperties( Data.ZAID(1001) )
        cls.scattering_center_definition_database = Collision.ScatteringCenterDefinitionDatabase()
        h_definition = cls.scattering_center_definition_database.createDefinition( "H1 @ 293.6K", Data.ZAID(1001) )

        h_definition.setPhotoatomicDataProperties(
          h_properties.getSharedPhotoatomicDataProperties(
                       Data.PhotoatomicDataProperties.Native_EPR_FILE, 0 ) )

        h_definition.setAdjointPhotoatomicDataProperties(
          h_properties.getSharedAdjointPhotoatomicDataProperties(
                Data.AdjointPhotoatomicDataProperties.Native_EPR_FILE, 0 ) )

        h_definition.setElectroatomicDataProperties(
          h_properties.getSharedElectroatomicDataProperties(
                     Data.ElectroatomicDataProperties.Native_EPR_FILE, 0 ) )

        h_definition.setAdjointElectroatomicDataProperties(
          h_properties.getSharedAdjointElectroatomicDataProperties(
              Data.AdjointElectroatomicDataProperties.Native_EPR_FILE, 0 ) )

        h_definition.setNuclearDataProperties(
          h1_properties.getSharedNuclearDataPropertiesAtMeV(
                                         Data.NuclearDataProperties.ACE_FILE,
                                         7,
                                         2.53010E-08,
                                         True ) )

        cls.material_definition_database = Collision.MaterialDefinitionDatabase()

        cls.material_definition_database.addDefinition( "H1 @ 293.6K", 1,
                                                      ("H1 @ 293.6K",), (1.0,) )

        cls.unfilled_model = Geometry.InfiniteMediumModel( 1, 1, -1.0 )

        tmp_particle_distribution = ActiveRegion.StandardParticleDistribution( "test dist" )

        cls.particle_distribution = tmp_particle_distribution

    def setUp(self):
        # Initialize the FRENSIE global MPI Session
        argc = 2
        argv = ["tstMonteCarlo.Manager.ParticleSimulationManagerFactory.py", "default", "--report_level=detailed"]
        self.session = MPI.GlobalMPISession( argc, argv )

#-----------------------------------------------------------------------------#
    # Check that a particle simulation can be restarted
    def testRestart_basic(self):
        "*Test MonteCarlo.Manager.ParticleSimulationManager restart_basic"
        properties = MonteCarlo.SimulationProperties()
        properties.setParticleMode( MonteCarlo.PHOTON_MODE )
        properties.setSimulationWallTime( 0.25 )
        properties.setMaxRendezvousBatchSize( 10 )

        model = Collision.FilledGeometryModel(
                                self.database_path,
                                self.scattering_center_definition_database,
                                self.material_definition_database,
                                properties,
                                self.unfilled_model,
                                False )

        source_component = [ ActiveRegion.StandardPhotonSourceComponent(
                                                     self.source_id,
                                                     1.0,
                                                     self.unfilled_model,
                                                     self.particle_distribution ) ]

        source = ActiveRegion.StandardParticleSource( source_component )
        event_handler = Event.EventHandler( properties )

        # There are no surfaces - this is just a dummy estimator to test the
        # restart feature
        estimator_1 = Event.WeightMultipliedSurfaceCurrentEstimator( 1, 1.0, [2] )
        estimator_1.setParticleTypes( [MonteCarlo.PHOTON] )
        estimator_1.setCosineDiscretization( [-1.0, 0.0, 1.0] )

        event_handler.addEstimator( estimator_1 )

        del estimator_1

        estimator_2 = Event.WeightMultipliedCellTrackLengthFluxEstimator( 2, 1.0, [1], [1.0] )
        
        estimator_2.setParticleTypes( [MonteCarlo.PHOTON] )
        estimator_2.setEnergyDiscretization( [0.001, 0.01, 0.1, 1.0, 10.0] )
        estimator_2.setCollisionNumberDiscretization( [0, 1, 10] )

        event_handler.addEstimator( estimator_2 )

        del estimator_2
        
        factory = Manager.ParticleSimulationManagerFactory( model,
                                                            source,
                                                            event_handler,
                                                            properties,
                                                            "test_sim",
                                                            self.archive_type,
                                                            self.threads )

        manager = factory.getManager()
        manager.useMultipleRendezvousFiles()
        manager.runSimulation()

        next_history = manager.getNextHistory()
        rendezvous_number = manager.getNumberOfRendezvous()

        del model
        del source
        del event_handler
        del manager

        # Reset variables
        source_component = None
        source = None
        factory = None
        manager = None

        archive_name = "test_sim_rendezvous_"
        archive_name += str( rendezvous_number - 1 )
        archive_name += "."
        archive_name += self.archive_type

        factory = Manager.ParticleSimulationManagerFactory( archive_name, self.threads )

        manager = factory.getManager()
        manager.runSimulation()

        self.assertTrue( manager.getNextHistory() > next_history )
        self.assertTrue( manager.getNumberOfRendezvous() > rendezvous_number )

#-----------------------------------------------------------------------------#
    # Check that a particle simulation manager can be restarted
    def testRestart_add_histories(self):
        "*Test MonteCarlo.Manager.ParticleSimulationManager restart_add_histories"
        properties = MonteCarlo.SimulationProperties()
        properties.setParticleMode( MonteCarlo.PHOTON_MODE )
        properties.setSimulationWallTime( 0.25 )
        properties.setMaxRendezvousBatchSize( 10 )

        model = Collision.FilledGeometryModel(
                                self.database_path,
                                self.scattering_center_definition_database,
                                self.material_definition_database,
                                properties,
                                self.unfilled_model,
                                False )

        source_component = [ ActiveRegion.StandardPhotonSourceComponent(
                                                     self.source_id,
                                                     1.0,
                                                     self.unfilled_model,
                                                     self.particle_distribution ) ]

        source = ActiveRegion.StandardParticleSource( source_component )
        event_handler = Event.EventHandler( properties )

        factory = Manager.ParticleSimulationManagerFactory( model,
                                                            source,
                                                            event_handler,
                                                            properties,
                                                            "test_sim",
                                                            self.archive_type,
                                                            self.threads )

        manager = factory.getManager()
        manager.useMultipleRendezvousFiles()
        manager.runSimulation()

        next_history = manager.getNextHistory()
        rendezvous_number = manager.getNumberOfRendezvous()

        # Reset variables
        source_component = None
        source = None
        event_handler = None
        factory = None
        manager = None

        archive_name = "test_sim_rendezvous_"
        archive_name += str( rendezvous_number - 1 )
        archive_name += "."
        archive_name += self.archive_type

        factory = Manager.ParticleSimulationManagerFactory( archive_name, 5, self.threads )

        manager = factory.getManager()
        manager.runSimulation()

        self.assertEqual( manager.getNextHistory(), next_history+5 )
        self.assertTrue( manager.getNumberOfRendezvous() > rendezvous_number )

#-----------------------------------------------------------------------------#
    # Check that a particle simulation manager can be restarted
    def testRestart_new_wall_time(self):
        "*Test MonteCarlo.Manager.ParticleSimulationManager restart_new_wall_time"
        properties = MonteCarlo.SimulationProperties()
        properties.setParticleMode( MonteCarlo.PHOTON_MODE )
        properties.setSimulationWallTime( 0.25 )
        properties.setMaxRendezvousBatchSize( 10 )

        model = Collision.FilledGeometryModel(
                                self.database_path,
                                self.scattering_center_definition_database,
                                self.material_definition_database,
                                properties,
                                self.unfilled_model,
                                False )

        source_component = [ ActiveRegion.StandardPhotonSourceComponent(
                                                     self.source_id,
                                                     1.0,
                                                     self.unfilled_model,
                                                     self.particle_distribution ) ]

        source = ActiveRegion.StandardParticleSource( source_component )
        event_handler = Event.EventHandler( properties )

        factory = Manager.ParticleSimulationManagerFactory( model,
                                                            source,
                                                            event_handler,
                                                            properties,
                                                            "test_sim",
                                                            self.archive_type,
                                                            self.threads )

        manager = factory.getManager()
        manager.useMultipleRendezvousFiles()
        manager.runSimulation()

        next_history = manager.getNextHistory()
        rendezvous_number = manager.getNumberOfRendezvous()

        # Reset variables
        source_component = None
        source = None
        event_handler = None
        factory = None
        manager = None

        archive_name = "test_sim_rendezvous_"
        archive_name += str( rendezvous_number - 1 )
        archive_name += "."
        archive_name += self.archive_type

        factory = Manager.ParticleSimulationManagerFactory( archive_name, 0.1, self.threads )

        manager = factory.getManager()
        manager.runSimulation()

        self.assertTrue( manager.getNextHistory() > next_history )
        self.assertTrue( manager.getNumberOfRendezvous() > rendezvous_number )

#-----------------------------------------------------------------------------#
    # Check that a particle simulation manager can be restarted
    def testRestart_add_histories_new_wall_time(self):
        "*Test MonteCarlo.Manager.ParticleSimulationManager restart_add_histories_new_wall_time"
        properties = MonteCarlo.SimulationProperties()
        properties.setParticleMode( MonteCarlo.PHOTON_MODE )
        properties.setSimulationWallTime( 0.25 )
        properties.setMaxRendezvousBatchSize( 10 )

        model = Collision.FilledGeometryModel(
                                self.database_path,
                                self.scattering_center_definition_database,
                                self.material_definition_database,
                                properties,
                                self.unfilled_model,
                                False )

        source_component = [ ActiveRegion.StandardPhotonSourceComponent(
                                                     self.source_id,
                                                     1.0,
                                                     self.unfilled_model,
                                                     self.particle_distribution ) ]

        source = ActiveRegion.StandardParticleSource( source_component )
        event_handler = Event.EventHandler( properties )

        factory = Manager.ParticleSimulationManagerFactory( model,
                                                            source,
                                                            event_handler,
                                                            properties,
                                                            "test_sim",
                                                            self.archive_type,
                                                            self.threads )

        manager = factory.getManager()
        manager.useMultipleRendezvousFiles()
        manager.runSimulation()

        next_history = manager.getNextHistory()
        rendezvous_number = manager.getNumberOfRendezvous()

        # Reset variables
        source_component = None
        source = None
        event_handler = None
        factory = None
        manager = None

        archive_name = "test_sim_rendezvous_"
        archive_name += str( rendezvous_number - 1 )
        archive_name += "."
        archive_name += self.archive_type

        factory = Manager.ParticleSimulationManagerFactory( archive_name, 5, 0.1, self.threads )

        manager = factory.getManager()
        manager.runSimulation()

        self.assertEqual( manager.getNextHistory(), next_history+5 )
        self.assertTrue( manager.getNumberOfRendezvous() > rendezvous_number )

#-----------------------------------------------------------------------------#
    # Check that a particle simulation manager can be restarted
    def testRestart_updated_props(self):
        "*Test MonteCarlo.Manager.ParticleSimulationManager restart_updated_props"
        properties = MonteCarlo.SimulationProperties()
        properties.setParticleMode( MonteCarlo.PHOTON_MODE )
        properties.setSimulationWallTime( 0.25 )
        properties.setMaxRendezvousBatchSize( 10 )

        model = Collision.FilledGeometryModel(
                                self.database_path,
                                self.scattering_center_definition_database,
                                self.material_definition_database,
                                properties,
                                self.unfilled_model,
                                False )

        source_component = [ ActiveRegion.StandardPhotonSourceComponent(
                                                     self.source_id,
                                                     1.0,
                                                     self.unfilled_model,
                                                     self.particle_distribution ) ]

        source = ActiveRegion.StandardParticleSource( source_component )
        event_handler = Event.EventHandler( properties )

        factory = Manager.ParticleSimulationManagerFactory( model,
                                                            source,
                                                            event_handler,
                                                            properties,
                                                            "test_sim",
                                                            self.archive_type,
                                                            self.threads )

        manager = factory.getManager()
        manager.useMultipleRendezvousFiles()
        manager.runSimulation()

        next_history = manager.getNextHistory()
        rendezvous_number = manager.getNumberOfRendezvous()

        # Reset variables
        source_component = None
        source = None
        event_handler = None
        factory = None
        manager = None

        archive_name = "test_sim_rendezvous_"
        archive_name += str( rendezvous_number - 1 )
        archive_name += "."
        archive_name += self.archive_type

        updated_properties = MonteCarlo.SimulationGeneralProperties()
        updated_properties.setNumberOfHistories( 16 )
        updated_properties.setMinNumberOfRendezvous( 2 )
        updated_properties.setMaxRendezvousBatchSize( 100 )
        updated_properties.setMinNumberOfBatchesPerRendezvous( 2 )
        updated_properties.setMaxBatchSize( 10 )
        updated_properties.setSimulationWallTime( 1.0 )

        factory = Manager.ParticleSimulationManagerFactory( archive_name, updated_properties, self.threads )

        manager = factory.getManager()
        manager.runSimulation()

        self.assertEqual( manager.getNextHistory(), next_history+16 )
        self.assertTrue( manager.getNumberOfRendezvous() > rendezvous_number )
        self.assertEqual( manager.getRendezvousBatchSize(), 8 )
        self.assertEqual( manager.getBatchSize(), 4 )

#-----------------------------------------------------------------------------#
# Custom main
#-----------------------------------------------------------------------------#
if __name__ == "__main__":

    # Create the test suite object
    suite = unittest.TestSuite()

    # Add the test cases to the test suite
    suite.addTest(unittest.makeSuite(ParticleSimulationManagerTestCase))
    suite.addTest(ParametrizedTestCase.parametrize(ParticleSimulationManagerRestartTestCase, archive_type="xml", source_id=0))
    suite.addTest(ParametrizedTestCase.parametrize(ParticleSimulationManagerRestartTestCase, archive_type="txt", source_id=1))
    suite.addTest(ParametrizedTestCase.parametrize(ParticleSimulationManagerRestartTestCase, archive_type="bin", source_id=2))
    if options.have_hdf5:
      suite.addTest(ParametrizedTestCase.parametrize(ParticleSimulationManagerRestartTestCase, archive_type="h5fa", source_id=3))

    print >>sys.stderr, \
        "\n**************************\n" + \
        "Testing MonteCarlo.Manager.ParticleSimulationManager \n" + \
        "**************************\n"
    result = unittest.TextTestRunner(verbosity=options.verbosity).run(suite)

    errs_plus_fails = len(result.errors) + len(result.failures)

    if errs_plus_fails == 0:
        print "End Result: TEST PASSED"

    # Delete the suite
    del suite

    # Exit
    sys.exit(errs_plus_fails)

#-----------------------------------------------------------------------------#
# end tstMonteCarlo.Manager.ParticleSimulationManager.py
#-----------------------------------------------------------------------------#
